


<!DOCTYPE html>
<html
  lang="en"
  dir="ltr"
  class="scroll-smooth"
  data-default-appearance="dark"
  data-auto-appearance="true"
><head>
  <meta charset="utf-8" />
  
    <meta http-equiv="content-language" content="en" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="rgb(255,255,255)" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  
  <title>Accelerating Ceph RPM Packaging: Using Multithreaded Compression &middot; Better Tomorrow with Computer Science</title>
    <meta name="title" content="Accelerating Ceph RPM Packaging: Using Multithreaded Compression &middot; Better Tomorrow with Computer Science" />
  
  <meta name="description" content="This post explains how we can accelerate buildig a Ceph RPM package. Knowledge in the post can be generally applied to packaging all other applications, not only Ceph.
Ceph source code is managed by Github 1, and it contains several shell scripts for packaging as well. Before illustrating how these scripts work, we have to figure out how RPM packaging works.
1. RPM Packaing 101 # RPM (originally stands for Red Hat Package Manager) is a package management system developed by Red Hat 2." />
  
  
  
  <link rel="canonical" href="/2020-11-07/accelerating-ceph-rpm-packaging-using-multithreaded-compression/" />
  
  
  
  
  
  
  
  
  
    
  
  
  <link
    type="text/css"
    rel="stylesheet"
    href="/css/main.bundle.min.10f51640c62455dc3b2a174cda772e2fee409808982122a17db5129978d396e5a9dec1b325b2c50f7e5f7dbc7d8c62bdcb89f86574ad3d8359acad96fb66e674.css"
    integrity="sha512-EPUWQMYkVdw7KhdM2ncuL&#43;5AmAiYISKhfbUSmXjTluWp3sGzJbLFD35ffbx9jGK9y4n4ZXStPYNZrK2W&#43;2bmdA=="
  />
  
  
  <script type="text/javascript" src="/js/appearance.min.75869c865625ed3d10fe38f2274fa90938094d28b518ee2088f544a29fe6b826626bae550302adcbde61e83ba341bdd928a250d644367723ce01e798033098c5.js" integrity="sha512-dYachlYl7T0Q/jjyJ0&#43;pCTgJTSi1GO4giPVEop/muCZia65VAwKty95h6DujQb3ZKKJQ1kQ2dyPOAeeYAzCYxQ=="></script>
  
  
    
    
  
  
  
    
    <script defer type="text/javascript" id="script-bundle" src="/js/main.bundle.min.6441f8726be4ada95c479c17d34ce0c4f9f734611947904121e8c317136b5a33ca848f1a18723cc0e68b65872b89b5da63293ec3deb8650739be41c518e6f292.js" integrity="sha512-ZEH4cmvkralcR5wX00zgxPn3NGEZR5BBIejDFxNrWjPKhI8aGHI8wOaLZYcribXaYyk&#43;w964ZQc5vkHFGObykg==" data-copy="Copy" data-copied="Copied"></script>
  
  
  
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/site.webmanifest" />
  
  
  
  
  
  
  
  <meta property="og:title" content="Accelerating Ceph RPM Packaging: Using Multithreaded Compression" />
<meta property="og:description" content="This post explains how we can accelerate buildig a Ceph RPM package. Knowledge in the post can be generally applied to packaging all other applications, not only Ceph.
Ceph source code is managed by Github 1, and it contains several shell scripts for packaging as well. Before illustrating how these scripts work, we have to figure out how RPM packaging works.
1. RPM Packaing 101 # RPM (originally stands for Red Hat Package Manager) is a package management system developed by Red Hat 2." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/2020-11-07/accelerating-ceph-rpm-packaging-using-multithreaded-compression/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-11-07T19:07:00+09:00" />
<meta property="article:modified_time" content="2020-11-07T19:07:00+09:00" /><meta property="og:site_name" content="Better Tomorrow with Computer Science" />


  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Accelerating Ceph RPM Packaging: Using Multithreaded Compression"/>
<meta name="twitter:description" content="This post explains how we can accelerate buildig a Ceph RPM package. Knowledge in the post can be generally applied to packaging all other applications, not only Ceph.
Ceph source code is managed by Github 1, and it contains several shell scripts for packaging as well. Before illustrating how these scripts work, we have to figure out how RPM packaging works.
1. RPM Packaing 101 # RPM (originally stands for Red Hat Package Manager) is a package management system developed by Red Hat 2."/>

  
  <script type="application/ld+json">
  [{
    "@context": "https://schema.org",
    "@type": "Article",
    "articleSection": "Posts",
    "name": "Accelerating Ceph RPM Packaging: Using Multithreaded Compression",
    "headline": "Accelerating Ceph RPM Packaging: Using Multithreaded Compression",
    
    "abstract": "This post explains how we can accelerate buildig a Ceph RPM package. Knowledge in the post can be generally applied to packaging all other applications, not only Ceph.\nCeph source code is managed by Github 1, and it contains several shell scripts for packaging as well. Before illustrating how these scripts work, we have to figure out how RPM packaging works.\n1. RPM Packaing 101 # RPM (originally stands for Red Hat Package Manager) is a package management system developed by Red Hat 2.",
    "inLanguage": "en",
    "url" : "\/2020-11-07\/accelerating-ceph-rpm-packaging-using-multithreaded-compression\/",
    "author" : {
      "@type": "Person",
      "name": "Insu Jang"
    },
    "copyrightYear": "2020",
    "dateCreated": "2020-11-07T19:07:00\u002b09:00",
    "datePublished": "2020-11-07T19:07:00\u002b09:00",
    
    "dateModified": "2020-11-07T19:07:00\u002b09:00",
    
    "keywords": ["study","ceph","rpm"],
    
    "mainEntityOfPage": "true",
    "wordCount": "1489"
  }]
  </script>


  
  <meta name="author" content="Insu Jang" />
  
    
      <link href="mailto:insujang@umich.edu" rel="me" />
    
      <link href="https://www.linkedin.com/in/insujang" rel="me" />
    
      <link href="https://github.com/insujang" rel="me" />
    
      <link href="https://scholar.google.com/citations?user=U6I8Y98AAAAJ" rel="me" />
    
  
  
  
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Raleway:ital,wght@0,400;0,700;1,400;1,700&display=swap"
    rel="stylesheet">





<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css"
    integrity="sha384-vKruj+a13U8yHIkAyGgK1J3ArTLzrFGBbBc0tDp4ad/EyewESeXE/Iv67Aj8gKZ0" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js"
    integrity="sha384-PwRUT/YqbnEjkZO0zZxNqcxACrXe+j766U2amXcgMg5457rve2Y7I6ZJSm2A0mS4"
    crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js"
    integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous" onload="renderMathInElement(document.body, {
        delimiters: [
            {left: '$$', right: '$$' , display: true},
            {left: '$', right: '$' , display: false},
            {left: '\\(', right: '\\)', display: false},
            {left: '\\[', right: '\\]', display: true}
        ] });"></script>































































  
  
  
  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-158110335-1', 'auto');
	
	ga('send', 'pageview');
}
</script>


  
  
</head>
<body
    class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32"
  >
    <div id="the-top" class="absolute flex self-center">
      <a
        class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600"
        href="#main-content"
        ><span class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400"
          >&darr;</span
        >Skip to main content</a
      >
    </div>
    
    
      <header class="py-6 font-semibold text-neutral-900 dark:text-neutral print:hidden sm:py-10">
  <nav class="flex items-start justify-between sm:items-center">
    
    <div class="flex flex-row items-center">
      
  <a
    class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2"
    rel="me"
    href="/"
    >Better Tomorrow with Computer Science</a
  >

      

    </div>
    
    
      <ul class="flex list-none flex-col ltr:text-right rtl:text-left sm:flex-row">
        
          
            <li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0">
              <a
                class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2"
                href="/#about"
                title=""
                >About</a
              >
            </li>
          
            <li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0">
              <a
                class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2"
                href="/research/"
                title=""
                >Research</a
              >
            </li>
          
            <li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0">
              <a
                class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2"
                href="/posts/"
                title=""
                >Posts</a
              >
            </li>
          
        
        
      </ul>
    
  </nav>
</header>

    
    <div class="relative flex flex-col grow">
      <main id="main-content" class="grow">
        
  <article>
    <header class="max-w-prose">
      
      <h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">
        Accelerating Ceph RPM Packaging: Using Multithreaded Compression
      </h1>
      <div class="mt-8 mb-12 text-base text-neutral-500 dark:text-neutral-400 print:hidden">
        





  
  



  

  
  
    
  

  

  

  

  

  <div class="flex flex-row flex-wrap items-center">
    
    
      <time datetime="2020-11-07 19:07:00 &#43;0900 &#43;0900">Nov 7, 2020</time>
    

    
    
  </div>

  
  
    <div class="my-1 text-xs text-neutral-500 dark:text-neutral-400 ">
      
        
          
            <a
              href="/tags/study/"
              class="rounded-md border border-neutral-200 px-1 py-[1px] hover:border-primary-300 hover:text-primary-700 dark:border-neutral-600 dark:hover:border-primary-600 dark:hover:text-primary-400"
              >study</a
            >
          
            <a
              href="/tags/ceph/"
              class="rounded-md border border-neutral-200 px-1 py-[1px] hover:border-primary-300 hover:text-primary-700 dark:border-neutral-600 dark:hover:border-primary-600 dark:hover:text-primary-400"
              >ceph</a
            >
          
            <a
              href="/tags/rpm/"
              class="rounded-md border border-neutral-200 px-1 py-[1px] hover:border-primary-300 hover:text-primary-700 dark:border-neutral-600 dark:hover:border-primary-600 dark:hover:text-primary-400"
              >rpm</a
            >
          
        
      
    </div>
  


      </div>
      
    </header>
    <section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row">
      
        <div class="order-first px-0 lg:order-last lg:max-w-xs ltr:lg:pl-8 rtl:lg:pr-8">
          <div class="toc ltr:pl-5 rtl:pr-5 print:hidden lg:sticky lg:top-10">
            <details open class="mt-0 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5">
  <summary
    class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden"
  >
    Table of Contents
  </summary>
  <div
    class="py-2 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"
  >
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#1-rpm-packaing-101">1. RPM Packaing 101</a></li>
        <li><a href="#2-building-a-ceph-rpm-package">2. Building a Ceph RPM Package</a>
          <ul>
            <li><a href="#using-spec-file">Using SPEC file</a></li>
            <li><a href="#using-tarball">Using tarball</a></li>
            <li><a href="#using-srpm-source-rpm">Using SRPM (Source RPM).</a></li>
          </ul>
        </li>
        <li><a href="#3-accelerating-rpm-package-build">3. Accelerating RPM Package Build</a></li>
        <li><a href="#4-conclusion">4. Conclusion</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</details>

          </div>
        </div>
      
      <div class="min-w-0 min-h-0 max-w-prose grow">
        <p>This post explains how we can accelerate buildig a Ceph RPM package.
Knowledge in the post can be generally applied to packaging all other applications, not only Ceph.</p>
<p>Ceph source code is managed by Github <sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>, and it contains several shell scripts for packaging as well.
Before illustrating how these scripts work, we have to figure out how RPM packaging works.</p>
<h2 id="1-rpm-packaing-101" class="relative group">1. RPM Packaing 101 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#1-rpm-packaing-101" aria-label="Anchor">#</a></span></h2>
<p>RPM (originally stands for Red Hat Package Manager) is a package management system developed by Red Hat <sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup>.
Many Linux distributions such as Red Hat Enterprise Linux (RHEL), Fedora, CentOS, OpenSUSE are using RPM as their default package management system.</p>
<p>Red Hat provides a very well written guide document that how we can package RPMs <sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup>.
This post provides very simplified illustration. For more detail, please refer to the document.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ dnf install rpm-build rpmdevtools
$ rpmdev-setuptree
$ rpmbuild &lt;options&gt;
</code></pre></div><ul>
<li><code>rpmdev-setuptree</code> creates a basic directory structure in your home directory: <code>/home/user/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}</code>.</li>
<li><code>rpmbuild</code> builds a RPM package based on data in <code>/home/user/rpmbuild</code>. Generated RPM packages are stored in <code>/home/user/RPMS</code>.</li>
</ul>
<p>Details for each directory are explained in <a href="https://rpm-packaging-guide.github.io/#rpm-packaging-workspace"   target="_blank">the document</a>.</p>
<h2 id="2-building-a-ceph-rpm-package" class="relative group">2. Building a Ceph RPM Package <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#2-building-a-ceph-rpm-package" aria-label="Anchor">#</a></span></h2>
<p><code>rpmbuild</code> accepts three ways to build a RPM Package: using a spec file (e.g. <code>ceph.spec</code>), using source files (tarball archive), or using a SRPM (Source RPM) package.</p>
<pre tabindex="0"><code>$ rpmbuild --help
Usage: rpmbuild [OPTION...]

Build options with [ &lt;specfile&gt; | &lt;tarball&gt; | &lt;source package&gt; ]:
      -bb                        build binary package only from &lt;specfile&gt;                       # use specfile
      -bs                        build source package only from &lt;specfile&gt;
      -rb                        build binary package only from &lt;source package&gt;                 # use SRPM
      -rs                        build source package only from &lt;source package&gt;
      -tb                        build binary package only from &lt;tarball&gt;                        # use source files
      -ts                        build source package only from &lt;tarball&gt;
      ...
</code></pre><h3 id="using-spec-file" class="relative group">Using SPEC file <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#using-spec-file" aria-label="Anchor">#</a></span></h3>
<p>I will not use RPM package with spec file, because in <code>ceph.spec</code> it downloads archived source code from website, but I wanted custom build.</p>
<p>ceph.spec:</p>
<pre tabindex="0"><code>...
%global _remote_tarball_prefix https://download.ceph.com/tarballs/   &lt;&lt;---
...

#################################################################################
# main package definition
#################################################################################
Name:           ceph
Version:        16.0.0
Release:        6971.g6352099561%{?dist}
%if 0%{?fedora} || 0%{?rhel}
Epoch:          2
%endif

# define _epoch_prefix macro which will expand to the empty string if epoch is
# undefined
%global _epoch_prefix %{?epoch:%{epoch}:}

Summary:        User space components of the Ceph file system
License:        LGPL-2.1 and LGPL-3.0 and CC-BY-SA-3.0 and GPL-2.0 and BSL-1.0 and BSD-3-Clause and MIT
%if 0%{?suse_version}
Group:          System/Filesystems
%endif
URL:            http://ceph.com/
Source0:        %{?_remote_tarball_prefix}ceph-16.0.0-6971-g6352099561.tar.bz2    &lt;&lt;---
...
</code></pre><blockquote>
<p>This <code>ceph.spec</code> file is automatically generated from <code>ceph.spec.in</code> by <code>make-dist</code> command.</p>
<p>You can use <code>./make-dist &lt;version_name&gt;</code> to customize the version.
By default, it uses <code>git describe --log --match 'v*' | se d's/^v//'</code> for version name.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="nv">version</span><span class="o">=</span><span class="nv">$1</span>
<span class="o">[</span> -z <span class="s2">&#34;</span><span class="nv">$version</span><span class="s2">&#34;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">version</span><span class="o">=</span><span class="k">$(</span>git describe --long --match <span class="s1">&#39;v*&#39;</span> <span class="p">|</span> sed <span class="s1">&#39;s/^v//&#39;</span><span class="k">)</span>
<span class="k">if</span> expr index <span class="nv">$version</span> <span class="s1">&#39;-&#39;</span> &gt; /dev/null<span class="p">;</span> <span class="k">then</span>
    <span class="nv">rpm_version</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$version</span> <span class="p">|</span> cut -d - -f 1-1<span class="k">)</span>
    <span class="nv">rpm_release</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$version</span> <span class="p">|</span> cut -d - -f 2- <span class="p">|</span> sed <span class="s1">&#39;s/-/./&#39;</span><span class="k">)</span>
<span class="k">else</span>
    <span class="nv">rpm_version</span><span class="o">=</span><span class="nv">$version</span>
    <span class="nv">rpm_release</span><span class="o">=</span><span class="m">0</span>
<span class="k">fi</span>
...

<span class="c1"># populate files with version strings</span>
<span class="nb">echo</span> <span class="s2">&#34;including src/.git_version, ceph.spec&#34;</span>

<span class="o">(</span>git rev-parse HEAD <span class="p">;</span> <span class="nb">echo</span> <span class="nv">$version</span><span class="o">)</span> 2&gt; /dev/null &gt; src/.git_version

<span class="k">for</span> spec in ceph.spec.in<span class="p">;</span> <span class="k">do</span>
   cat <span class="nv">$spec</span> <span class="p">|</span>
       sed <span class="s2">&#34;s/@PROJECT_VERSION@/</span><span class="nv">$rpm_version</span><span class="s2">/g&#34;</span> <span class="p">|</span>
       sed <span class="s2">&#34;s/@RPM_RELEASE@/</span><span class="nv">$rpm_release</span><span class="s2">/g&#34;</span> <span class="p">|</span>
       sed <span class="s2">&#34;s/@TARBALL_BASENAME@/ceph-</span><span class="nv">$version</span><span class="s2">/g&#34;</span> &gt; <span class="sb">`</span><span class="nb">echo</span> <span class="nv">$spec</span> <span class="p">|</span> sed <span class="s1">&#39;s/.in$//&#39;</span><span class="sb">`</span>
<span class="k">done</span>
</code></pre></div></blockquote>
<p>By default, packaging a Ceph RPM with <code>ceph.spec</code> downloads archived source code from <code>https://download.ceph.com/tarballs/ceph-&lt;version&gt;.tar.bz2</code>, most of which are not provided since 2016 (Recently, they only provides <code>tar.gz</code>, not <code>tar.bz2</code>).
It also requires customized archived source code to be uploaded to the server, preventing cloned source code to be used for RPM package build.
Therefore, I will not use <code>ceph.spec</code> for RPM package build.</p>
<p>You can still use SPEC file with your source code, not tarballs, but it requires modification on the SPEC file, which I do not want. Please refer to <a href="https://serverfault.com/a/311449"   target="_blank">here</a> for more details.</p>
<h3 id="using-tarball" class="relative group">Using tarball <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#using-tarball" aria-label="Anchor">#</a></span></h3>
<p>Ceph provides a script <code>make-dist</code>, which automatically generates <code>tar.bz2</code> tarball.
After generating a tarball, we can build a RPM package with it by <code>rpmbuild -tb /path/to/ceph/tarball.tar.bz2</code>.</p>
<p>However, it returns an error that is not understandable:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">error: Found more than one spec file in ceph-16.0.0-6971-g6352099561.tar.bz2
</code></pre></div><p>I currently have no idea how to solve it. Instead, I use SRPM.</p>
<h3 id="using-srpm-source-rpm" class="relative group">Using SRPM (Source RPM). <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#using-srpm-source-rpm" aria-label="Anchor">#</a></span></h3>
<p>Ceph also provides a script <code>make-srpm.sh</code> to generate a SRPM package.
It first uses <code>make-dist</code> to build a tarball, and then build a SRPM based on it and <code>ceph.spec</code>.</p>
<p>When the script is done, the result is as follows:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">/ceph $ ls
...
ceph-16.0.0-6971-g6352099561.tar.bz2       <span class="c1"># This is a tarball generated by make-dist.</span>
ceph-16.0.0-6971.g6352099561.el8.src.rpm   <span class="c1"># This is a SRPM package generated by make-srpm.sh.</span>
</code></pre></div><p>Simply using <code>rpmbuild</code>, we can build a Ceph RPM package based on the SRPM.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ ./make-srpm.sh
$ rpmbuild --rebuild ceph-16.0.0-6971.g6352099561.el8.src.rpm
</code></pre></div><p>I will use the SRPM for packaging a Ceph RPM.</p>
<blockquote>
<p>Technically, it is not different from using the SPEC file.
If you <em><strong>manually</strong></em> copies the tarballs (ceph-16.0.0-6971-g6352099561.tar.bz2) into <code>~/rpmbuild/SOURCES</code>, <code>rpmbuild</code> does not try to download the tarballs from the remote repository.</p>
<p>Using the SRPM seems to be exactly the same with the following:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">/path/to/ceph $ ./make-dist
/path/to/ceph $ cp ceph-16.0.0-6971-g6352099561.tar.bz2 ~/rpmbuild/SOURCES
/path/to/ceph $ cp ceph.spec ~/rpmbuild/SPECS
/path/to/ceph $ rpmbuild -bb ~/rpmbuild/SPECS/ceph.spec
</code></pre></div></blockquote>
<h2 id="3-accelerating-rpm-package-build" class="relative group">3. Accelerating RPM Package Build <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#3-accelerating-rpm-package-build" aria-label="Anchor">#</a></span></h2>
<p><a href="https://rpm-packaging-guide.github.io/#binary-rpms"   target="_blank">The manual</a> explains well what <code>rpmbuild</code> does during <code>rpmbuild --rebuild</code>:</p>
<ul>
<li>Install the contents of the SRPM (the SPEC file and the source code) into <code>~/rpmbuild/</code> directory (SPEC &ndash;&gt; <code>~/rpmbuild/SPECS</code>, source code tarball &ndash;&gt; <code>~/rpmbuild/SOURCES</code>)</li>
<li>Build using the installed contents.</li>
<li>Remove the SPEC file and the source code.</li>
</ul>
<p>To build the contents, <code>rpmbuild</code> uses instructions in the <code>%build</code> section in the SPEC file.</p>
<pre tabindex="0"><code>%build
...
mkdir build
cd build
CMAKE=cmake
${CMAKE} .. \
    -DCMAKE_INSTALL_PREFIX=%{_prefix} \
    -DCMAKE_INSTALL_LIBDIR=%{_libdir} \
    -DCMAKE_INSTALL_LIBEXECDIR=%{_libexecdir} \
    -DCMAKE_INSTALL_LOCALSTATEDIR=%{_localstatedir} \
    -DCMAKE_INSTALL_SYSCONFDIR=%{_sysconfdir} \
    -DCMAKE_INSTALL_MANDIR=%{_mandir} \
    -DCMAKE_INSTALL_DOCDIR=%{_docdir}/ceph \
    -DCMAKE_INSTALL_INCLUDEDIR=%{_includedir} \
    -DCMAKE_INSTALL_SYSTEMD_SERVICEDIR=%{_unitdir} \
    -DWITH_MANPAGE=ON \
    -DWITH_PYTHON3=%{python3_version} \
    -DWITH_MGR_DASHBOARD_FRONTEND=OFF ...

%if %{with cmake_verbose_logging}
cat ./CMakeFiles/CMakeOutput.log
cat ./CMakeFiles/CMakeError.log
%endif

make &quot;$CEPH_MFLAGS_JOBS&quot;

%if 0%{with make_check}
%check
# run in-tree unittests
cd build
ctest &quot;$CEPH_MFLAGS_JOBS&quot;
%endif
</code></pre><p>where <code>$CEPH_MFLAGS_JOBS</code> is defined <code>-j$CEPH_SMP_NCPUS</code>, which is carefully set for parallel build, which would not paralyze the entire system:</p>
<pre tabindex="0"><code># Parallel build settings ...
CEPH_MFLAGS_JOBS=&quot;%{?_smp_mflags}&quot;
CEPH_SMP_NCPUS=$(echo &quot;$CEPH_MFLAGS_JOBS&quot; | sed 's/-j//')
%if 0%{?__isa_bits} == 32
# 32-bit builds can use 3G memory max, which is not enough even for -j2
CEPH_SMP_NCPUS=&quot;1&quot;
%endif
# do not eat all memory
echo &quot;Available memory:&quot;
free -h
echo &quot;System limits:&quot;
ulimit -a
if test -n &quot;$CEPH_SMP_NCPUS&quot; -a &quot;$CEPH_SMP_NCPUS&quot; -gt 1 ; then
    mem_per_process=2500
    max_mem=$(LANG=C free -m | sed -n &quot;s|^Mem: *\([0-9]*\).*$|\1|p&quot;)
    max_jobs=&quot;$(($max_mem / $mem_per_process))&quot;
    test &quot;$CEPH_SMP_NCPUS&quot; -gt &quot;$max_jobs&quot; &amp;&amp; CEPH_SMP_NCPUS=&quot;$max_jobs&quot; &amp;&amp; echo &quot;Warning: Reducing build parallelism to -j$max_jobs because of memory limits&quot;
    test &quot;$CEPH_SMP_NCPUS&quot; -le 0 &amp;&amp; CEPH_SMP_NCPUS=&quot;1&quot; &amp;&amp; echo &quot;Warning: Not using parallel build at all because of memory limits&quot;
fi
export CEPH_SMP_NCPUS
export CEPH_MFLAGS_JOBS=&quot;-j$CEPH_SMP_NCPUS&quot;
</code></pre><p>Therefore, building phase is parallelized, and not a problem.</p>
<p>However, as the final step, <code>rpmbuild</code> builds a package with built binaries and libraries with compression.
By default, <code>rpmbuild</code> uses <strong>level 2 XZ compression</strong> to build a RPM package, which only uses one core.</p>

  
  
  
  
  
  
    
    
    
      <figure>
        <img class="my-0 rounded-md" src="/assets/images/201107/rpmbuild-1core.png" alt="image" />
        <figcaption><code>rpmbuild</code> only uses one core for packaging step. This becomes a huge bottleneck for Ceph RPM packaging. Current <code>rpmbuild</code> version is 4.14.2.</figcaption>
      </figure>
    
  


<blockquote>
<p>You can check which algorithm is currently set for <code>rpmbuild</code> with <code>rpmbuild --showrc</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ rpmbuild --showrc
...
-13: _binary_payload    w2.xzdio
...
</code></pre></div><p>You can refer to <code>/usr/lib/rpm/macros</code> that which options are available and their meaning.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ cat /usr/lib/rpm/macros
...
<span class="c1">#       Compression type and level for source/binary package payloads.</span>
<span class="c1">#               &#34;w9.gzdio&#34;      gzip level 9 (default).</span>
<span class="c1">#               &#34;w9.bzdio&#34;      bzip2 level 9.</span>
<span class="c1">#               &#34;w6.xzdio&#34;      xz level 6, xz&#39;s default.</span>
<span class="c1">#               &#34;w7T16.xzdio&#34;   xz level 7 using 16 thread (xz only)</span>
<span class="c1">#               &#34;w6.lzdio&#34;      lzma-alone level 6, lzma&#39;s default</span>
...
</code></pre></div></blockquote>
<p>According to the explanation, <code>w2.xzdio</code> means level 2 XZ compression type.
There is <a href="https://linuxreviews.org/Comparison_of_Compression_Algorithms"   target="_blank">a well done analysis</a><sup id="fnref:4"><a href="#fn:4" class="footnote-ref" role="doc-noteref">4</a></sup> of compression algorithms. According to the analysis, default xz with single core was <strong>unbearably slow</strong>.</p>
<blockquote>
<p>The reason that maintainers were reluctant to adapt multithreaded compression seems memory usage. Refer to <a href="https://patchwork.openembedded.org/patch/140380/"   target="_blank">this mail archive</a>.</p>
</blockquote>
<p>Now you can override this <code>rpmbuild</code> variable with <code>--define</code> option.
I want to change it to use just multithreading. Then compression type must be <code>w2T16.xzdio</code> (xz level 2 using 16 threads. I am using AMD Ryzen 2700X, which has 16 threads total).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ rpmbuild --define <span class="s2">&#34;_binary_payload w2T16.xzdio&#34;</span> --rebuild ceph-16.0.0-6971.g6352099561.el8.src.rpm
$ &lt;output omitted&gt;
</code></pre></div>
  
  
  
  
  
  
    
    
    
      <figure>
        <img class="my-0 rounded-md" src="/assets/images/201107/rpmbuild-16cores.png" alt="image" />
        <figcaption><code>rpmbuild</code> with the overriden <code>_binary_payload</code> uses nearly all 16 cores.</figcaption>
      </figure>
    
  


<p>The entire <code>rpmbuild</code> time change measured with <code>time</code> command is as follows:</p>
<ul>
<li>Without multithreading compression: 85m 3.681s</li>
<li>With multithreading compression (16 threads): 65m40.709s <strong>(-22.8%)</strong></li>
</ul>
<p>Note, that the elapsed time includes the entire process; even includes compile and link time, which takes a lot of portion of the entire build process.
It is a huge improvement and I think it can be improved further!</p>
<h2 id="4-conclusion" class="relative group">4. Conclusion <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#4-conclusion" aria-label="Anchor">#</a></span></h2>
<p>I accelerated RPM packaging by using multithreaded compression using <code>rpmbuild</code> feature.</p>
<p>In August 2020, <a href="https://github.com/rpm-software-management/rpm/pull/1324"   target="_blank">a pull request</a> has been merged to the <code>rpmbuild</code> main branch.
It enables thread autodetection for automated parallel compression (xz and zstd compression type only).
I used <code>rpmbuild</code> 4.14.2 so I was not get any benefit from the commits, however, it would be good to try this as well.</p>
<section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p><a href="https://github.com/ceph/ceph"   target="_blank">Ceph</a>&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2" role="doc-endnote">
<p><a href="https://en.wikipedia.org/wiki/RPM_Package_Manager"   target="_blank">RPM Package Manager</a>&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:3" role="doc-endnote">
<p><a href="https://rpm-packaging-guide.github.io"   target="_blank">RPM Packaging Guide</a>&#160;<a href="#fnref:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:4" role="doc-endnote">
<p><a href="https://linuxreviews.org/Comparison_of_Compression_Algorithms"   target="_blank">Comparison of Compression Algorithms</a>&#160;<a href="#fnref:4" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section>

      </div>
    </section>
    <footer class="pt-8 max-w-prose print:hidden">
      
  <div class="flex">
    
      
      
        
        <img
          class="!mt-0 !mb-0 h-24 w-24 rounded-full ltr:mr-4 rtl:ml-4"
          width="96"
          height="96"
          alt="Insu Jang"
          src="/profile_hufec33d24ce71c5c22cc5620410f7e1d1_126481_192x192_fill_q75_box_smart1.jpg"
        />
      
    
    <div class="place-self-center">
      
        <div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">
          Author
        </div>
        <div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">
          Insu Jang
        </div>
      
      
      <div class="text-2xl sm:text-lg">
  <div class="flex flex-wrap text-neutral-400 dark:text-neutral-500">
    
      
        <a
          class="px-1 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400"
          href="mailto:insujang@umich.edu"
          target="_blank"
          aria-label="Email"
          rel="me noopener noreferrer"
          >

  <span class="relative inline-block align-text-bottom icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1c-27.64 140.9 68.65 266.2 199.1 285.1c19.01 2.888 36.17-12.26 36.17-31.49l.0001-.6631c0-15.74-11.44-28.88-26.84-31.24c-84.35-12.98-149.2-86.13-149.2-174.2c0-102.9 88.61-185.5 193.4-175.4c91.54 8.869 158.6 91.25 158.6 183.2l0 16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98 .0036c-7.299 0-13.2 4.992-15.12 11.68c-24.85-12.15-54.24-16.38-86.06-5.106c-38.75 13.73-68.12 48.91-73.72 89.64c-9.483 69.01 43.81 128 110.9 128c26.44 0 50.43-9.544 69.59-24.88c24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3C495.1 107.1 361.2-9.332 207.8 20.73zM239.1 304.3c-26.47 0-48-21.56-48-48.05s21.53-48.05 48-48.05s48 21.56 48 48.05S266.5 304.3 239.1 304.3z"/></svg>

  </span>

</a
        >
      
    
      
        <a
          class="px-1 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://www.linkedin.com/in/insujang"
          target="_blank"
          aria-label="Linkedin"
          rel="me noopener noreferrer"
          >

  <span class="relative inline-block align-text-bottom icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>

  </span>

</a
        >
      
    
      
        <a
          class="px-1 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://github.com/insujang"
          target="_blank"
          aria-label="Github"
          rel="me noopener noreferrer"
          >

  <span class="relative inline-block align-text-bottom icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>

  </span>

</a
        >
      
    
      
        <a
          class="px-1 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://scholar.google.com/citations?user=U6I8Y98AAAAJ"
          target="_blank"
          aria-label="Google-Scholar"
          rel="me noopener noreferrer"
          >

  <span class="relative inline-block align-text-bottom icon">
    <!-- Uploaded to: SVG Repo, www.svgrepo.com, Transformed by: SVG Repo Mixer Tools -->
<svg fill="currentColor" width="800px" height="800px" viewBox="0 0 24 24" role="img" xmlns="http://www.w3.org/2000/svg"><title>Google Scholar icon</title><path d="M12 24a7 7 0 1 1 0-14 7 7 0 0 1 0 14zm0-24L0 9.5l4.838 3.94A8 8 0 0 1 12 9a8 8 0 0 1 7.162 4.44L24 9.5z"/></svg>
  </span>

</a
        >
      
    
  </div>

</div>
    </div>
  </div>


      

      
  
    
    
    
    <div class="pt-8">
      <hr class="border-dotted border-neutral-300 dark:border-neutral-600" />
      <div class="flex justify-between pt-3">
        <span>
          
            <a class="group flex" href="/2020-11-03/deploying-a-ceph-development-environment-cluster/">
              <span
                class="mr-2 text-neutral-700 transition-transform group-hover:-translate-x-[2px] group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400"
                >&larr;</span
              >
              <span
                class="ml-2 text-neutral-700 transition-transform group-hover:translate-x-[2px] group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400"
                >&rarr;</span
              >
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >Deploying a Ceph Development Environment Cluster</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                    <time datetime="2020-11-03 13:09:00 &#43;0900 &#43;0900">Nov 3, 2020</time>
                  
                </span>
              </span>
            </a>
          
        </span>
        <span>
          
            <a class="group flex text-right" href="/2020-11-09/building-container-image-inside-container-using-buildah/">
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >Building Container Image inside Container using Buildah</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                    <time datetime="2020-11-09 15:09:00 &#43;0900 &#43;0900">Nov 9, 2020</time>
                  
                </span>
              </span>
              <span
                class="ml-2 text-neutral-700 transition-transform group-hover:translate-x-[2px] group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400"
                >&rarr;</span
              >
              <span
                class="mr-2 text-neutral-700 transition-transform group-hover:-translate-x-[2px] group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400"
                >&larr;</span
              >
            </a>
          
        </span>
      </div>
    </div>
  


      
    </footer>
  </article>

        
          <div
            class="pointer-events-none absolute top-[100vh] bottom-0 w-12 ltr:right-0 rtl:left-0"
          >
            <a
              href="#the-top"
              class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 backdrop-blur hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400"
              aria-label="Scroll to top"
              title="Scroll to top"
            >
              &uarr;
            </a>
          </div>
        
      </main><footer class="py-10 print:hidden">
  
  
  <div class="flex items-center justify-between">
    <div>
      
      
        <p class="text-sm text-neutral-500 dark:text-neutral-400">
            &copy;
            2024
            Insu Jang
        </p>
      
      
      
        <p class="text-xs text-neutral-500 dark:text-neutral-400">
          
          
          Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500"
            href="https://gohugo.io/" target="_blank" rel="noopener noreferrer">Hugo</a> &amp; <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href="https://git.io/hugo-congo" target="_blank" rel="noopener noreferrer">Congo</a>
        </p>
      
    </div>
    
    
      <div
        class="ltr:mr-14 rtl:ml-14 cursor-pointer text-sm text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400"
      >
        <button id="appearance-switcher" type="button">
          <div
            class="flex items-center justify-center w-12 h-12 dark:hidden"
            title="Switch to dark appearance"
          >
            

  <span class="relative inline-block align-text-bottom icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M32 256c0-123.8 100.3-224 223.8-224c11.36 0 29.7 1.668 40.9 3.746c9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3c9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480C132.1 480 32 379.6 32 256z"/></svg>

  </span>


          </div>
          <div
            class="items-center justify-center hidden w-12 h-12 dark:flex"
            title="Switch to light appearance"
          >
            

  <span class="relative inline-block align-text-bottom icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02 0-95.1 42.98-95.1 95.1S202.1 351.1 256 351.1s95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347L446.1 255.1l63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7l-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89L164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6L12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256l-63.15 91.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7l19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109l109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69 0-127.1-57.31-127.1-127.1c0-70.69 57.31-127.1 127.1-127.1s127.1 57.3 127.1 127.1C383.1 326.7 326.7 383.1 256 383.1z"/></svg>

  </span>


          </div>
        </button>
      </div>
    
  </div>
  
  
</footer>

    </div>
  </body>
</html>
