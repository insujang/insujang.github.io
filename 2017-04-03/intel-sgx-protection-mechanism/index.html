


<!DOCTYPE html>
<html
  lang="en"
  dir="ltr"
  class="scroll-smooth"
  data-default-appearance="dark"
  data-auto-appearance="true"
><head>
  <meta charset="utf-8" />
  
    <meta http-equiv="content-language" content="en" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="rgb(255,255,255)" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  
  <title>Intel SGX Protection Mechanism &middot; Better Tomorrow with Computer Science</title>
    <meta name="title" content="Intel SGX Protection Mechanism &middot; Better Tomorrow with Computer Science" />
  
  <meta name="description" content="All Figure numbers are same with those in the paper.
Glossary #  PMH: Page Miss Handler. MMU: Memory Management Unit. TLB: Translation Look-aside Buffer. FSM: Finite State Machine. EPC: Enclave Page Cache. EPCM: Enclave Page Cache Map. PRM: Processor Reserved Memory. ELRANGE: Enclave Linear Address Range.  Address Translation # Concepts #  Section 2.5.1 Address Translation Concepts
 System software relies on the CPU&rsquo;s address translation mechanism for implementing isolation among less privileged pieces of software." />
  
  
  
  <link rel="canonical" href="/2017-04-03/intel-sgx-protection-mechanism/" />
  
  
  
  
  
  
  
  
  
    
  
  
  <link
    type="text/css"
    rel="stylesheet"
    href="/css/main.bundle.min.9264a849fe940226c4c0483f5f928ac9a54f61fe388cc4daf3a2415eb6243a9c15df8dacf265b0568858ccb14bee5a00882484609f31bbf3635d0897cece5a51.css"
    integrity="sha512-kmSoSf6UAibEwEg/X5KKyaVPYf44jMTa86JBXrYkOpwV342s8mWwVohYzLFL7loAiCSEYJ8xu/NjXQiXzs5aUQ=="
  />
  
  
  <script type="text/javascript" src="/js/appearance.min.75869c865625ed3d10fe38f2274fa90938094d28b518ee2088f544a29fe6b826626bae550302adcbde61e83ba341bdd928a250d644367723ce01e798033098c5.js" integrity="sha512-dYachlYl7T0Q/jjyJ0&#43;pCTgJTSi1GO4giPVEop/muCZia65VAwKty95h6DujQb3ZKKJQ1kQ2dyPOAeeYAzCYxQ=="></script>
  
  
    
    
  
  
  
    
    <script defer type="text/javascript" id="script-bundle" src="/js/main.bundle.min.6441f8726be4ada95c479c17d34ce0c4f9f734611947904121e8c317136b5a33ca848f1a18723cc0e68b65872b89b5da63293ec3deb8650739be41c518e6f292.js" integrity="sha512-ZEH4cmvkralcR5wX00zgxPn3NGEZR5BBIejDFxNrWjPKhI8aGHI8wOaLZYcribXaYyk&#43;w964ZQc5vkHFGObykg==" data-copy="Copy" data-copied="Copied"></script>
  
  
  
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/site.webmanifest" />
  
  
  
  
  
  
  
  <meta property="og:title" content="Intel SGX Protection Mechanism" />
<meta property="og:description" content="All Figure numbers are same with those in the paper.
Glossary #  PMH: Page Miss Handler. MMU: Memory Management Unit. TLB: Translation Look-aside Buffer. FSM: Finite State Machine. EPC: Enclave Page Cache. EPCM: Enclave Page Cache Map. PRM: Processor Reserved Memory. ELRANGE: Enclave Linear Address Range.  Address Translation # Concepts #  Section 2.5.1 Address Translation Concepts
 System software relies on the CPU&rsquo;s address translation mechanism for implementing isolation among less privileged pieces of software." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/2017-04-03/intel-sgx-protection-mechanism/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2017-04-03T14:09:50+09:00" />
<meta property="article:modified_time" content="2017-04-03T14:09:50+09:00" /><meta property="og:site_name" content="Better Tomorrow with Computer Science" />


  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Intel SGX Protection Mechanism"/>
<meta name="twitter:description" content="All Figure numbers are same with those in the paper.
Glossary #  PMH: Page Miss Handler. MMU: Memory Management Unit. TLB: Translation Look-aside Buffer. FSM: Finite State Machine. EPC: Enclave Page Cache. EPCM: Enclave Page Cache Map. PRM: Processor Reserved Memory. ELRANGE: Enclave Linear Address Range.  Address Translation # Concepts #  Section 2.5.1 Address Translation Concepts
 System software relies on the CPU&rsquo;s address translation mechanism for implementing isolation among less privileged pieces of software."/>

  
  <script type="application/ld+json">
  [{
    "@context": "https://schema.org",
    "@type": "Article",
    "articleSection": "Posts",
    "name": "Intel SGX Protection Mechanism",
    "headline": "Intel SGX Protection Mechanism",
    
    "abstract": "All Figure numbers are same with those in the paper.\nGlossary #  PMH: Page Miss Handler. MMU: Memory Management Unit. TLB: Translation Look-aside Buffer. FSM: Finite State Machine. EPC: Enclave Page Cache. EPCM: Enclave Page Cache Map. PRM: Processor Reserved Memory. ELRANGE: Enclave Linear Address Range.  Address Translation # Concepts #  Section 2.5.1 Address Translation Concepts\n System software relies on the CPU\u0026rsquo;s address translation mechanism for implementing isolation among less privileged pieces of software.",
    "inLanguage": "en",
    "url" : "\/2017-04-03\/intel-sgx-protection-mechanism\/",
    "author" : {
      "@type": "Person",
      "name": "Insu Jang"
    },
    "copyrightYear": "2017",
    "dateCreated": "2017-04-03T14:09:50\u002b09:00",
    "datePublished": "2017-04-03T14:09:50\u002b09:00",
    
    "dateModified": "2017-04-03T14:09:50\u002b09:00",
    
    "keywords": ["research","sgx"],
    
    "mainEntityOfPage": "true",
    "wordCount": "1091"
  }]
  </script>


  
  <meta name="author" content="Insu Jang" />
  
    
      <link href="mailto:insujang@umich.edu" rel="me" />
    
      <link href="https://www.linkedin.com/in/insujang" rel="me" />
    
      <link href="https://github.com/insujang" rel="me" />
    
      <link href="https://scholar.google.com/citations?user=U6I8Y98AAAAJ" rel="me" />
    
  
  
  




<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css"
    integrity="sha384-vKruj+a13U8yHIkAyGgK1J3ArTLzrFGBbBc0tDp4ad/EyewESeXE/Iv67Aj8gKZ0" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js"
    integrity="sha384-PwRUT/YqbnEjkZO0zZxNqcxACrXe+j766U2amXcgMg5457rve2Y7I6ZJSm2A0mS4"
    crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js"
    integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous" onload="renderMathInElement(document.body, {
        delimiters: [
            {left: '$$', right: '$$' , display: true},
            {left: '$', right: '$' , display: false},
            {left: '\\(', right: '\\)', display: false},
            {left: '\\[', right: '\\]', display: true}
        ] });"></script>































































  
  
  
  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-158110335-1', 'auto');
	
	ga('send', 'pageview');
}
</script>


  
  
</head>
<body
    class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32"
  >
    <div id="the-top" class="absolute flex self-center">
      <a
        class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600"
        href="#main-content"
        ><span class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400"
          >&darr;</span
        >Skip to main content</a
      >
    </div>
    
    
      <header class="py-6 font-semibold text-neutral-900 dark:text-neutral print:hidden sm:py-10">
  <nav class="flex items-start justify-between sm:items-center">
    
    <div class="z-40 flex flex-row items-center">
      
  <a
    class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2"
    rel="me"
    href="/"
    >Better Tomorrow with Computer Science</a
  >

      

    </div>
    
      
      <label id="menu-button" for="menu-controller" class="block sm:hidden">
        <input type="checkbox" id="menu-controller" class="hidden" />
        <div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400">
          

  <span class="relative inline-block align-text-bottom icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416C433.7 64 448 78.33 448 96C448 113.7 433.7 128 416 128H32C14.33 128 0 113.7 0 96zM0 256C0 238.3 14.33 224 32 224H416C433.7 224 448 238.3 448 256C448 273.7 433.7 288 416 288H32C14.33 288 0 273.7 0 256zM416 448H32C14.33 448 0 433.7 0 416C0 398.3 14.33 384 32 384H416C433.7 384 448 398.3 448 416C448 433.7 433.7 448 416 448z"/></svg>

  </span>


        </div>
        <div
          id="menu-wrapper"
          class="invisible fixed inset-0 z-30 m-auto h-screen w-screen cursor-default overflow-auto bg-neutral-100/50 opacity-0 backdrop-blur-sm transition-opacity dark:bg-neutral-900/50"
        >
          <ul
            class="mx-auto flex w-full max-w-7xl list-none flex-col overflow-visible px-6 py-6 ltr:text-right rtl:text-left sm:px-14 sm:py-10 sm:pt-10 md:px-24 lg:px-32"
          >
            <li class="mb-1">
              <span class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"
                >

  <span class="relative inline-block align-text-bottom icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z"/></svg>

  </span>

</span
              >
            </li>
            
              
                <li class="mb-1">
                  <a
                    class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2"
                    href="/#about"
                    title=""
                    >About</a
                  >
                </li>
              
                <li class="mb-1">
                  <a
                    class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2"
                    href="/research/"
                    title=""
                    >Research</a
                  >
                </li>
              
                <li class="mb-1">
                  <a
                    class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2"
                    href="/posts/"
                    title=""
                    >Posts</a
                  >
                </li>
              
            
            
          </ul>
        </div>
      </label>
      
      <ul class="hidden list-none flex-row ltr:text-right rtl:text-left sm:flex">
        
          
            <li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0">
              <a
                class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2"
                href="/#about"
                title=""
                >About</a
              >
            </li>
          
            <li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0">
              <a
                class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2"
                href="/research/"
                title=""
                >Research</a
              >
            </li>
          
            <li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0">
              <a
                class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2"
                href="/posts/"
                title=""
                >Posts</a
              >
            </li>
          
        
        
      </ul>
    
  </nav>
</header>

    
    <div class="relative flex flex-col grow">
      <main id="main-content" class="grow">
        
  <article>
    <header class="max-w-prose">
      
      <h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">
        Intel SGX Protection Mechanism
      </h1>
      <div class="mt-8 mb-12 text-base text-neutral-500 dark:text-neutral-400 print:hidden">
        





  
  



  

  
  
    
  

  

  

  

  

  <div class="flex flex-row flex-wrap items-center">
    
    
      <time datetime="2017-04-03 14:09:50 &#43;0900 &#43;0900">Apr 3, 2017</time>
    

    
    
  </div>

  
  
    <div class="my-1 text-xs text-neutral-500 dark:text-neutral-400 ">
      
        
          
            <a
              href="/tags/research/"
              class="rounded-md border border-neutral-200 px-1 py-[1px] hover:border-primary-300 hover:text-primary-700 dark:border-neutral-600 dark:hover:border-primary-600 dark:hover:text-primary-400"
              >research</a
            >
          
            <a
              href="/tags/sgx/"
              class="rounded-md border border-neutral-200 px-1 py-[1px] hover:border-primary-300 hover:text-primary-700 dark:border-neutral-600 dark:hover:border-primary-600 dark:hover:text-primary-400"
              >sgx</a
            >
          
        
      
    </div>
  


      </div>
      
    </header>
    <section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row">
      
        <div class="order-first px-0 lg:order-last lg:max-w-xs ltr:lg:pl-8 rtl:lg:pr-8">
          <div class="toc ltr:pl-5 rtl:pr-5 print:hidden lg:sticky lg:top-10">
            <details open class="mt-0 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5">
  <summary
    class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden"
  >
    Table of Contents
  </summary>
  <div
    class="py-2 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"
  >
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#glossary">Glossary</a></li>
        <li><a href="#address-translation">Address Translation</a>
          <ul>
            <li><a href="#concepts">Concepts</a></li>
            <li><a href="#address-translation-cache">Address Translation Cache</a></li>
          </ul>
        </li>
        <li><a href="#intel-sgx">Intel SGX</a>
          <ul>
            <li><a href="#overview">Overview</a></li>
            <li><a href="#how-epc-pages-are-mapped-into-elrange">How EPC Pages are Mapped into ELRANGE?</a></li>
          </ul>
        </li>
        <li><a href="#sgx-address-translation-attack-protection-details">SGX Address Translation Attack Protection Details</a></li>
        <li><a href="#references">References</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</details>

          </div>
        </div>
      
      <div class="min-w-0 min-h-0 max-w-prose grow">
        <p><em>All Figure numbers are same with those in the paper.</em></p>
<h2 id="glossary" class="relative group">Glossary <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#glossary" aria-label="Anchor">#</a></span></h2>
<ul>
<li>PMH: Page Miss Handler.</li>
<li>MMU: Memory Management Unit.</li>
<li>TLB: Translation Look-aside Buffer.</li>
<li>FSM: Finite State Machine.</li>
<li>EPC: Enclave Page Cache.</li>
<li>EPCM: Enclave Page Cache Map.</li>
<li>PRM: Processor Reserved Memory.</li>
<li>ELRANGE: Enclave Linear Address Range.</li>
</ul>
<h2 id="address-translation" class="relative group">Address Translation <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#address-translation" aria-label="Anchor">#</a></span></h2>
<h3 id="concepts" class="relative group">Concepts <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#concepts" aria-label="Anchor">#</a></span></h3>
<blockquote>
<p>Section 2.5.1 Address Translation Concepts</p>
</blockquote>
<p>System software relies on the CPU&rsquo;s address translation mechanism for implementing isolation among less privileged pieces of software.</p>
<p>From a systems perspective, address translation is a layer of indirection between</p>
<ul>
<li><em>virtual address</em>, which are used by a program&rsquo;s memory load and store instructions</li>
<li><em>physical address</em>, which reference the physical address space.</li>
</ul>
<p>The mapping between virtual and physical addresses is defined by <em>page tables</em>, which are managed by the system software.
The translation process is carried out by dedicated hardware in the CPU, which is referred to as the <strong>address translation unit</strong> or <strong>memory management unit (MMU)</strong>.</p>
<p>



  
  
  
    <figure>
      <img class="my-0 rounded-md" src="/assets/images/170403/address_translation_concept.png" alt="address_translation_concept" />
      
    </figure>
  

{: width=&ldquo;700px&rdquo; .center-image}
<em>Figure 10. Address translation concept</em>
{: .center}</p>
<h3 id="address-translation-cache" class="relative group">Address Translation Cache <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#address-translation-cache" aria-label="Anchor">#</a></span></h3>
<blockquote>
<p>Section 2.11.5 Caches and Address Translation</p>
</blockquote>
<p>Address translation requires up to 20 memory accesses, so it is impractical to perform a full address translation for every cache access. Instead, address translation results are cached in the <strong>translation look-aside buffer (TLB)</strong>.</p>
<p>When a virtual address is not contained in a core&rsquo;s TLB, the Page Miss Handler (PMH) performs a <em>page walk</em> to translate the virtual address, and the result is stored in the TLB.</p>
<p>In the Intel architecture, the PMH is implemented in hardware, so the TLB is nevery directly exposed to software.</p>
<blockquote>
<p>Section 2.14.3. Microcode and Address Translation</p>
<p>In order to minimize the latency of a page walk, the PMH is implemented as a Finite-State Machine (FSM).</p>
</blockquote>
<h2 id="intel-sgx" class="relative group">Intel SGX <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#intel-sgx" aria-label="Anchor">#</a></span></h2>
<h3 id="overview" class="relative group">Overview <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#overview" aria-label="Anchor">#</a></span></h3>
<p>Intel Software Guard Extensions (SGX) is a hardware-based data protection technology,
developed by Intel Corporation.</p>
<p>The cental concept of SGX is the <em><strong>enclave</strong></em>, a protected environment that contains the code and data pertaining to a security-sensitive computation.</p>
<h4 id="the-enclave-page-cache-epc" class="relative group">The Enclave Page Cache (EPC) <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#the-enclave-page-cache-epc" aria-label="Anchor">#</a></span></h4>
<blockquote>
<p>Section 5.1.1 The Enclave Page Cache (EPC)</p>
</blockquote>
<p>The contents of enclaves and the associated data structures are stored in the <em>Enclave Page Cache (EPC)</em>, which is a subset of DRAM that cannot be directly accessed by other software, including system software and SMM code. The CPU&rsquo;s integrated memory controllers also reject DMA transfers targeting the EPC, thus protecting it from access by other peripherals.</p>
<p>It is a subset of processor reserved memory (PRM).</p>
<p>



  
  
  
    <figure>
      <img class="my-0 rounded-md" src="/assets/images/170403/epc.png" alt="epc" />
      
    </figure>
  

{: width=600px .center-image}
<em>Figure 60. EPC and PRM layout</em>
{: .center}</p>
<!--
#### The Enclave Page Cache Map (EPCM)
As the system software is not trusted, SGX processors check the correctness of the system software's virtual address allocation decisions, and refused to perform any action that would compromise SGX's security guarantees.

For example, if the system software attempts to allocate the same EPC page to two enclaves, the SGX instruction used to perform the allocation will fail.

It is impossible for enclave to communicate via shared memory using EPC pages. Fortunately, enclaves can share untrusted non-EPC memory.
-->
<h4 id="the-enclave-linear-address-range-elrange" class="relative group">The Enclave Linear Address Range (ELRANGE) <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#the-enclave-linear-address-range-elrange" aria-label="Anchor">#</a></span></h4>
<blockquote>
<p>Section 5.2.1 The Enclave Linear Address Range (ELRANGE)</p>
</blockquote>
<p>Each enclave designates an area in its virtual address space, called the <em>enclave linear address range (ELRANGE)</em>, which is used to map the code and the sensitive data stored in the enclave&rsquo;s EPC pages. The virtual address space outside ELRANGE is mapped to access non-EPC memory via the same virtual addresses as the enclave&rsquo;s host process.</p>
<p>



  
  
  
    <figure>
      <img class="my-0 rounded-md" src="/assets/images/170403/sgx_elrange.png" alt="sgx_elrange" />
      
    </figure>
  

{: width=&ldquo;600px&rdquo; .center-image}
<em>Figure 61. An enclave&rsquo;s EPC pages are accessed using a dedicated region in the enclave&rsquo;s virtual address space, called ELRANGE</em>
{: .center}</p>
<p>Enclaves must store all their code and private data inside ELRANGE, and must consider the memory outside ELRANGE to be an untrusted interface to outside world.</p>
<h3 id="how-epc-pages-are-mapped-into-elrange" class="relative group">How EPC Pages are Mapped into ELRANGE? <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#how-epc-pages-are-mapped-into-elrange" aria-label="Anchor">#</a></span></h3>
<blockquote>
<p>Section 5.2.3 Address Translation for SGX Enclaves</p>
<p>Section 6.2.1 Functional Description</p>
</blockquote>
<!--
**SGX's active memory mapping attacks defense mechanism** (section 3.7.3 and 3.7.4) **revolve around ensuring that each EPC page can only be mapped at a specific virtual address inside the ELRANGE.**

When an EPC page is allocated, its **intended virtual address** is recorded in the EPCM entry for the page,. in the ADDRESS field.

##### What is "intended virtual address"?
-->
<p>Virtual address allocation is system software&rsquo;s responsibility in SGX&rsquo;s model. So CPU cannot ask for system software to allocate a page in a specific virtual address.</p>
<p>In SGX1 model, only static memory allocation is supported. Hence, all EPC pages must be allocated to an enclave <strong>before</strong> initialization phase is finished.</p>
<p>



  
  
  
    <figure>
      <img class="my-0 rounded-md" src="/assets/images/170403/enclave_life_cycle.png" alt="enclave_life_cycle" />
      
    </figure>
  

{: width=&ldquo;600px&rdquo; .center-image}
<em>Figure 63. Enclave state transition diagram</em>
{: .center}</p>
<p>As you can see in Figure 63, EADD instruction, which is used for EPC page allocation, can only be called when the enclave is <em>uninitialized</em>.</p>
<p>As all EPC pages are allocated statically, the expected virtual addresses for EPC pages are <em><strong>continuous</strong></em>.</p>
<p><strong>Hence, the intended virtual address is defined as follows.</strong></p>
<blockquote>
<p>Section 5.6.3 Measuring EADD</p>
</blockquote>
<p>The virtual address of the newly created page is measured <em><strong>relatively</strong></em> to the start of the enclave&rsquo;s ELRANGE.</p>
<p>For example, if ELRANGE is set <code>{BASEADDR: 0x80000000, SIZE:0x200000}</code>, the second EPC page to be allocated to this enclave must have the virtual address <code>0x80001000</code>. (BASEADDR) + 4K * ENCLAVEOFFSET).</p>
<p>Then, how <code>BASEADDR</code> in ELRANGE is set?</p>
<blockquote>
<p>Section 5.6.1 Measuring ECREATE</p>
</blockquote>
<p>The enclave&rsquo;s measurement does not include BASEADDR field. (ELRANGE is specified as BASEADDR and SIZE) It <em><strong>allows the system software to load an enclave at any virtual address inside a host address that satisfied the ELRANGE restrictions (5.2.1).</strong></em></p>
<blockquote>
<p>ELRANGE restrictions from <em>section 5.2.1 ELRANGE</em></p>
<p>ELRANGE must meet the same constraints as a variable memory type range, the size must be a power of 2, and the base must be aligned to the size.</p>
</blockquote>
<p>To make it short, ELRANGE is defined by system software, but recorded by SGX at the time an enclave is created. All following EPC pages should have continuous virtual address from ELRANGE.</p>
<p>Here is a sample enclave&rsquo;s virtual address space in the paper.</p>
<p>



  
  
  
    <figure>
      <img class="my-0 rounded-md" src="/assets/images/170403/enclave_virtual_address_sample.png" alt="enclave_virtual_address_sample" />
      
    </figure>
  

{: width=&ldquo;500px&rdquo; .center-image}
<em>Figure 62. A possible layout of an enclave&rsquo;s virtual address space</em>
{: .center}</p>
<p>You can see that ADDRESS fields of EPC pages are continuous from BASEADDR (ELRANGE base address).</p>
<h2 id="sgx-address-translation-attack-protection-details" class="relative group">SGX Address Translation Attack Protection Details <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#sgx-address-translation-attack-protection-details" aria-label="Anchor">#</a></span></h2>
<blockquote>
<p>Section 6.2.1 Functional Description</p>
</blockquote>
<p>SGX adds the access control logic to the PMH. SGX&rsquo;s security checks are performed after SGX&rsquo;s access control log has access to the physical address produced by the page walker FSM.</p>
<p>



  
  
  
    <figure>
      <img class="my-0 rounded-md" src="/assets/images/170403/sgx_protection.png" alt="sgx_protection" />
      
    </figure>
  

{: width=&ldquo;500px&rdquo; .center-image}
<em>Figure 86. Security checks performed by the PMH.</em>
{: .center}</p>
<ul>
<li>If the logcal processor is outside enclave mode, only address translations that <strong>do not target the PRM range</strong> are allowed. (1)</li>
<li>When the logical processor is inside enclave mode, checks the following.
<ul>
<li>Is the <strong>physical address in PRM and EPC?</strong> (2)</li>
<li>Blocked EPC pages are in the process of being evicted, so PMH must not create new TLB entries targeting them.<br>
Is it blocked? (3)</li>
<li>Some EPC pages cannot be accessed by software. (e.g. SECS).<br>
Is this page that kind of one? (4)</li>
<li>An EPC page must only be accessed by the code of the enclave who owns the page.<br>
Is <strong>this process the owner of the EPC page?</strong> (5)</li>
<li>EPC pages must always be accessed using the virtual address when they were allocated to the enclave.<br>
Does the <strong>virtual address same with the intended one?</strong> (6)</li>
</ul>
</li>
</ul>
<h2 id="references" class="relative group">References <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#references" aria-label="Anchor">#</a></span></h2>
<ul>
<li>Software Guard Extensions, Wikipedia. [Online] <a href="https://en.wikipedia.org/wiki/Software_Guard_Extensions"   target="_blank">https://en.wikipedia.org/wiki/Software_Guard_Extensions</a></li>
<li>Costan V, Devadas S, Intel SGX Explained, IACR Cryptology ePrint Archive, 2016 <a href="https://pdfs.semanticscholar.org/2d7f/3f4ca3fbb15ae04533456e5031e0d0dc845a.pdf"   target="_blank">[link]</a></li>
</ul>

      </div>
    </section>
    <footer class="pt-8 max-w-prose print:hidden">
      
  <div class="flex">
    
      
      
        
        <img
          class="!mt-0 !mb-0 h-24 w-24 rounded-full ltr:mr-4 rtl:ml-4"
          width="96"
          height="96"
          alt="Insu Jang"
          src="/profile_hufec33d24ce71c5c22cc5620410f7e1d1_126481_192x192_fill_q75_box_smart1.jpg"
        />
      
    
    <div class="place-self-center">
      
        <div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">
          Author
        </div>
        <div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">
          Insu Jang
        </div>
      
      
      <div class="text-2xl sm:text-lg">
  <div class="flex flex-wrap text-neutral-400 dark:text-neutral-500">
    
      
        <a
          class="px-1 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400"
          href="mailto:insujang@umich.edu"
          target="_blank"
          aria-label="Email"
          rel="me noopener noreferrer"
          >

  <span class="relative inline-block align-text-bottom icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1c-27.64 140.9 68.65 266.2 199.1 285.1c19.01 2.888 36.17-12.26 36.17-31.49l.0001-.6631c0-15.74-11.44-28.88-26.84-31.24c-84.35-12.98-149.2-86.13-149.2-174.2c0-102.9 88.61-185.5 193.4-175.4c91.54 8.869 158.6 91.25 158.6 183.2l0 16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98 .0036c-7.299 0-13.2 4.992-15.12 11.68c-24.85-12.15-54.24-16.38-86.06-5.106c-38.75 13.73-68.12 48.91-73.72 89.64c-9.483 69.01 43.81 128 110.9 128c26.44 0 50.43-9.544 69.59-24.88c24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3C495.1 107.1 361.2-9.332 207.8 20.73zM239.1 304.3c-26.47 0-48-21.56-48-48.05s21.53-48.05 48-48.05s48 21.56 48 48.05S266.5 304.3 239.1 304.3z"/></svg>

  </span>

</a
        >
      
    
      
        <a
          class="px-1 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://www.linkedin.com/in/insujang"
          target="_blank"
          aria-label="Linkedin"
          rel="me noopener noreferrer"
          >

  <span class="relative inline-block align-text-bottom icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>

  </span>

</a
        >
      
    
      
        <a
          class="px-1 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://github.com/insujang"
          target="_blank"
          aria-label="Github"
          rel="me noopener noreferrer"
          >

  <span class="relative inline-block align-text-bottom icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>

  </span>

</a
        >
      
    
      
        <a
          class="px-1 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://scholar.google.com/citations?user=U6I8Y98AAAAJ"
          target="_blank"
          aria-label="Google-Scholar"
          rel="me noopener noreferrer"
          >

  <span class="relative inline-block align-text-bottom icon">
    <!-- Uploaded to: SVG Repo, www.svgrepo.com, Transformed by: SVG Repo Mixer Tools -->
<svg fill="currentColor" width="800px" height="800px" viewBox="0 0 24 24" role="img" xmlns="http://www.w3.org/2000/svg"><title>Google Scholar icon</title><path d="M12 24a7 7 0 1 1 0-14 7 7 0 0 1 0 14zm0-24L0 9.5l4.838 3.94A8 8 0 0 1 12 9a8 8 0 0 1 7.162 4.44L24 9.5z"/></svg>
  </span>

</a
        >
      
    
  </div>

</div>
    </div>
  </div>


      

      
  
    
    
    
    <div class="pt-8">
      <hr class="border-dotted border-neutral-300 dark:border-neutral-600" />
      <div class="flex justify-between pt-3">
        <span>
          
            <a class="group flex" href="/2017-04-03/pci-express-i/o-system/">
              <span
                class="mr-2 text-neutral-700 transition-transform group-hover:-translate-x-[2px] group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400"
                >&larr;</span
              >
              <span
                class="ml-2 text-neutral-700 transition-transform group-hover:translate-x-[2px] group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400"
                >&rarr;</span
              >
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >PCI Express I/O System</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                    <time datetime="2017-04-03 12:12:58 &#43;0900 &#43;0900">Apr 3, 2017</time>
                  
                </span>
              </span>
            </a>
          
        </span>
        <span>
          
            <a class="group flex text-right" href="/2017-04-05/intel-sgx-instructions-in-enclave-initialization/">
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >Intel SGX Instructions in Enclave Initialization</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                    <time datetime="2017-04-05 22:13:25 &#43;0900 &#43;0900">Apr 5, 2017</time>
                  
                </span>
              </span>
              <span
                class="ml-2 text-neutral-700 transition-transform group-hover:translate-x-[2px] group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400"
                >&rarr;</span
              >
              <span
                class="mr-2 text-neutral-700 transition-transform group-hover:-translate-x-[2px] group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400"
                >&larr;</span
              >
            </a>
          
        </span>
      </div>
    </div>
  


      
    </footer>
  </article>

        
          <div
            class="pointer-events-none absolute top-[100vh] bottom-0 w-12 ltr:right-0 rtl:left-0"
          >
            <a
              href="#the-top"
              class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 backdrop-blur hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400"
              aria-label="Scroll to top"
              title="Scroll to top"
            >
              &uarr;
            </a>
          </div>
        
      </main><footer class="py-10 print:hidden">
  
  
  <div class="flex items-center justify-between">
    <div>
      
      
        <p class="text-sm text-neutral-500 dark:text-neutral-400">
            &copy;
            2022
            Insu Jang
        </p>
      
      
      
        <p class="text-xs text-neutral-500 dark:text-neutral-400">
          
          
          Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500"
            href="https://gohugo.io/" target="_blank" rel="noopener noreferrer">Hugo</a> &amp; <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href="https://git.io/hugo-congo" target="_blank" rel="noopener noreferrer">Congo</a>
        </p>
      
    </div>
    
    
      <div
        class="ltr:mr-14 rtl:ml-14 cursor-pointer text-sm text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400"
      >
        <button id="appearance-switcher" type="button">
          <div
            class="flex items-center justify-center w-12 h-12 dark:hidden"
            title="Switch to dark appearance"
          >
            

  <span class="relative inline-block align-text-bottom icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M32 256c0-123.8 100.3-224 223.8-224c11.36 0 29.7 1.668 40.9 3.746c9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3c9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480C132.1 480 32 379.6 32 256z"/></svg>

  </span>


          </div>
          <div
            class="items-center justify-center hidden w-12 h-12 dark:flex"
            title="Switch to light appearance"
          >
            

  <span class="relative inline-block align-text-bottom icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02 0-95.1 42.98-95.1 95.1S202.1 351.1 256 351.1s95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347L446.1 255.1l63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7l-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89L164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6L12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256l-63.15 91.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7l19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109l109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69 0-127.1-57.31-127.1-127.1c0-70.69 57.31-127.1 127.1-127.1s127.1 57.3 127.1 127.1C383.1 326.7 326.7 383.1 256 383.1z"/></svg>

  </span>


          </div>
        </button>
      </div>
    
  </div>
  
  
</footer>

    </div>
  </body>
</html>
